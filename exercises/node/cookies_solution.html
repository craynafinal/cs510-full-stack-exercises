<!DOCTYPE html>
<html>
<head>
</head>
<body>
<pre>'use strict';<br /><br />var http = require('http'); // do not change this line<br /><br />// create a server just like in the first exercise<br />// as shown in the examples, you are asked to respond to various requests in different ways<br />// you have seen how to handle cookies before, this will use cookies more thoroughly<br /><br />// examples which serve as a specification for the required features, note that they have an order:<br />//&nbsp;&nbsp; http://localhost:8080/hello should return 'you must be new' in plain text and set an ident cookie<br />//&nbsp;&nbsp; http://localhost:8080/test should return 'last time you visited "/hello"' in plain text<br />//&nbsp;&nbsp; http://localhost:8080/world should return 'last time you visited "/test"' in plain text<br />//&nbsp;&nbsp; [now sending requests from a different browser]<br />//&nbsp;&nbsp; http://localhost:8080/lorem should return 'you must be new' in plain text and set an ident cookie<br />//&nbsp;&nbsp; http://localhost:8080/moshimoshi should return 'last time you visited "/lorem"' in plain text<br />//&nbsp;&nbsp; http://localhost:8080/ipsum should return 'last time you visited "/moshimoshi"' in plain text<br />//&nbsp;&nbsp; [sending requests from the original browser again]<br />//&nbsp;&nbsp; http://localhost:8080/again should return 'last time you visited "/world"' in plain text<br />//&nbsp;&nbsp; [the server restarts and looses all cookies]<br />//&nbsp;&nbsp; http://localhost:8080/servus should return 'you must be new' in plain text and set an ident cookie<br /><br />var storage = {};<br /><br />var server = http.createServer(function(req, res) {<br />&nbsp;&nbsp; &nbsp;if (req.url === '/favicon.ico') {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;res.end();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return;<br />&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;var strIdent = '';<br /><br />&nbsp;&nbsp; &nbsp;if (req.headers.cookie !== undefined) {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;var cookies = req.headers.cookie.split(',');<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (var i = 0; i &lt; cookies.length; i += 1) {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;var cookie = cookies[i].split('=');<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (cookie.length !== 2) {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;continue;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (cookie[0].trim() === 'ident') {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strIdent = cookie[1].trim(); <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;if (strIdent !== '') {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (storage.hasOwnProperty(strIdent) === false) {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strIdent = '';<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;if (strIdent === '') {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strIdent = Math.random().toString(36).substr(2, 6);<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;storage[strIdent] = {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'strIdent': strIdent,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'strVisited': []<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;res.writeHead(200, {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'Content-Type': 'text/plain',<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'Set-Cookie': 'ident=' + strIdent<br />&nbsp;&nbsp; &nbsp;});<br /><br />&nbsp;&nbsp; &nbsp;console.log(storage[strIdent].strVisited);<br /><br />&nbsp;&nbsp; &nbsp;if (storage[strIdent].strVisited.length === 0) {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;res.write('you must be new');<br />&nbsp;&nbsp; &nbsp;} else {<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;res.write('last time you visited "' + storage[strIdent].strVisited[0] + '"')<br />&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;storage[strIdent].strVisited.unshift(req.url);<br /><br />&nbsp;&nbsp; &nbsp;res.end();<br />});<br /><br />server.listen(process.env.PORT || 8081);</pre>
</body>
</html>